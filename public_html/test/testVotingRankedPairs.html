<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="author" content="Mauro Trevisan">
	<link rel="shortcut icon" href="../favicon.png" />

	<title>test Ranked Pairs voting</title>

	<script>
		//@see <a href="https://gist.github.com/asafh/a8e9af7a3e5282cbba27">Ranked Pairs voting</a>

		var enableDebug = false;


		/**
		 * Given a list of candidates and a list of ballots, return the first given number of winners.
		 *
		 * @param candidates			An array of strings, each representing a candidate
		 * @param ballots				An array of maps, each is a ballot
		 * @param [wantedWinners]	The number of wanted winners, optional, default to <code>1</code>
		 * @returns candidate		Array of winning candidates
		 */
		var elect = function(candidates, ballots, wantedWinners){
			if(typeof wantedWinners !== 'number')
				wantedWinners = 1;

			var winners = [];
			var noPreferenceValue = candidates.length;
			while(winners.length < wantedWinners){
				var thisElection = electSingle(candidates, ballots, noPreferenceValue);
				if(!thisElection.size){
					console.log('Could not elect another candidate, wanted ' + wantedWinners + ' winners, obtained ' + winners.length);

					break;
				}

				winners.push(thisElection);
				if(winners.length > wantedWinners)
					console.log('Too many winners, wanted ' + wantedWinners + ' winners, obtained ' + winners.length);
				if(winners.length >= wantedWinners)
					break;

				//filter out winner candidate(s)
				candidates = candidates.filter(function(candidate){
					return !thisElection.has(candidate);
				});
			}
			return winners;
		};

		/**
		 * Runs the Ranked Pairs vote
		 *
		 * @param candidates		An array of strings, each representing a candidate
		 * @param ballots			An array of maps, each is a ballot
		 * @param noPreferences	Value to associate to a candidate not present in the preference list
		 * @returns candidate	Set of candidates which are the sources of the locked-in graph (which is usually single, unless the graph has more than one source)
		 * 
		 * @private
		 */
		var electSingle = function(candidates, ballots, noPreferenceValue){
			if(!noPreferenceValue)
				return [];

			if(enableDebug){
				console.log(ballots.length + ' ballots:');
				console.log(candidates.join('\t'));
				ballots.forEach(function(ballot){
					var scores = candidates.map(function(candidate){
						return getPreference(candidate, ballot, noPreferenceValue);
					});
					console.log(scores.join('\t'));
				});
		 	}

			var majorities = calculateMajorities(candidates, ballots, noPreferenceValue);

			if(enableDebug)
				console.log('Majorities:\n', majorities);

			//lock in:
			var graph = {};
			candidates.forEach(function(candidate){
				graph[candidate] = [];
			});
			var reachable = function(from, to){
				//can be reached from one of the connections
				return graph[from].some(function(neighbor){
					return (neighbor === to || reachable(neighbor, to));
				});
			};

			majorities.forEach(function(m){
				//if x is accessible from y, then x->y would create a circle
				if(reachable(m.y, m.x))
					return;

				graph[m.x] = graph[m.x] || [];
				graph[m.x].push(m.y);
			});

			if(enableDebug)
				console.log('Locked graph:\n', graph);

			var sources = candidates.filter(function(candidate){
				//not reachable from every candidate
				return candidates.every(function(neighbor){
					return (graph[neighbor].indexOf(candidate) === -1);
				});
			});

			if(enableDebug)
				console.log('Graph sources:', sources);

			return new Set(sources);
		};

		/** @private */
		var calculateMajorities = function(candidates, ballots, noPreferenceValue){
			var v = {};
			var majorities = [];
			candidates.forEach(function(x){
				v[x] = {};
				var vx = v[x];
				candidates.forEach(function(y){
					if(y === x)
						return;

					vx[y] = ballots.reduce(function(count, ballot){
						return count + (getPreference(x, ballot, noPreferenceValue) < getPreference(y, ballot, noPreferenceValue)? 1: 0);
					}, 0);
					majorities.push({
						x: x,
						y: y,
						vxy: vx[y]
					});
				});
			});

			majorities.sort(function(m1, m2){
				//Vxy - Vzw
				var diff = m1.vxy - m2.vxy;
				//Vxy > Vzw
				if(diff > 0)
					return 1;

				if(diff === 0)
					//Vwz > Vyx smaller minority opposition (now wz and yz)
					return v[m2.y][m2.x] - v[m1.y][m1.x];

				return -1;
			}).reverse();

			return majorities;
		};

		/** @private */
		var getPreference = function(candidate, ballot, noPreferenceValue){
			var preference = ballot[candidate];
			if(preference === undefined)
				preference = noPreferenceValue;

			return preference;
		};



		//example:
		var candidates = ['ALV', 'LA', 'ILV', 'SA', 'BS', 'TM', 'SR', 'T'];
		var ballots = [
			//Stefano Battaggia
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Mauro Bonato
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Ferdinando Camon
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Franco Cavallini
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Deborah Coron
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Ezio Crosara
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Andrea Lunardon
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Loris Palmerini
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Franco Rocchetta
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Andrea Sinigallia
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Beglari Tavartkiladze
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined},
			//Mauro Trevisan
			{'ALV': 3,	'LA': 4,	'ILV': 6,	'SA': 5,	'BS': 1,	'TM': 0,	'SR': 2},
			//Denis Zarantonello
			{'ALV': undefined,	'LA': undefined,	'ILV': undefined,	'SA': undefined,	'BS': undefined,	'TM': undefined,	'SR': undefined,	'T': undefined}
		];

		winners = elect(candidates, ballots, candidates.length);

		winners.forEach(function(winner, i){
			console.log('Winner #', i + 1, ':', Array.from(winner).join(' = '));
		});

	</script>
</head>

<body>
</body>
</html>
