<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="author" content="Mauro Trevisan">
	<link rel="shortcut icon" href="../favicon.png" />

	<title>test Multidimensional Scaling</title>

	<script src="../app/AMDLoader.js"></script>

	<script>
		AMDLoader.config = {
			baseUrl: '../app',
			paths: {
				libs: '../libs'
			}
		};


		var linearRegression = function(y, x){
			var n = y.length,
				sum_x = 0,
				sum_y = 0,
				sum_xy = 0,
				sum_xx = 0,
				sum_yy = 0,
				i;
			for(i = 0; i < n; i ++){
				sum_x += x[i];
				sum_y += y[i];
				sum_xy += x[i] * y[i];
				sum_xx += x[i] * x[i];
				sum_yy += y[i] * y[i];
			}

			var slope = (n * sum_xy - sum_x * sum_y) / (n * sum_xx - sum_x * sum_x);
			return {
				slope: slope,
				intercept: (sum_y - slope * sum_x) / n,
				r2: Math.pow((n * sum_xy - sum_x * sum_y) / Math.sqrt((n * sum_xx - sum_x * sum_x) * (n * sum_yy - sum_y * sum_y)), 2)
			};
		};

		var euclideanDistance = function(a, b){
			return Math.sqrt(a.reduce(function(sum, current, i){ return sum + Math.pow(current - b[i], 2); }, 0));
		};


		//http://www.bristol.ac.uk/media-library/sites/cmm/migrated/documents/chapter3.pdf
		//https://homepage.uni-tuebingen.de/florian.wickelmaier/pubs/Wickelmaier2003SQRU.pdf
		//https://github.com/asarnow/mdscale/blob/master/src/main/java/mdscale/Data.java
		require(['../app/tools/data/ArrayHelper', '../test/lib/EVDecomposition'], function(ArrayHelper, EVDecomposition){
			var doubleCenter = function(J, P2, n){
				var c = [],
					d = [],
					i, j, k,
					sum0, sum1;
				for(i = 0; i < n; i ++){
					d[i] = [];
					for(j = 0; j < n; j ++){
						sum0 = 0;
						for(k = 0; k < n; k ++)
							sum0 += J[Math.min(i, k)][Math.max(k, i)] * P2[Math.min(k, j)][Math.max(j, k)];
						c[j] = sum0;
					}
					for(j = i; j < n; j ++){
						sum1 = 0;
						for(k = 0; k < n; k ++)
							sum1 += c[k] * J[Math.min(k, j)][Math.max(j, k)];
						d[i][j] = -0.5 * sum1;
					}
				}
				return d;
			};

			var multiplyDiagonal = function(a, b, n, m){
				var c = [],
					i, j;
				for(i = 0; i < n; i ++){
					c[i] = [];
					for(j = 0; j < m; j ++)
						c[i][j] = a[i][j] * b[j];
				}
				return c;
			};

			var reduceMatrix = function(matrix){
				return ArrayHelper.flatten(matrix).filter(function(el){ return (el != null); });
			};


			var dimensions = 27,
				variants = ['Anpeŧ', 'Pàđule', 'Uronŧo', 'Poŧale', 'Verona', 'Ŧenŧenige', 'Kaxan', 'Arfanta (Tarŧo)', 'Belun', 'Sa Stin', 'Venèsia', 'Krespaòro', 'Bixa', 'Montebèlo', 'Teoƚo', 'Roman', 'Vas', 'Toneđa', 'Vicensa', 'Lovadina', 'Kanpo San Martin', 'Istrana', 'Raldon', 'Méolo', 'Cerèa', 'Frata', 'Vila', 'Kaodàrxare', 'Trevixo', 'Viƚamarŧana', 'Italia'],
				matrix = [[0,0.2746453257778762,0.1605447591185847,0.1972432722013259,0.25331286210061404,0.24946197072874934,0.2665098673697668,0.26651335009137034,0.26296560914849537,0.26125735981021236,0.2662302253116014,0.2569442139702208,0.26793757836123616,0.2577250606403292,0.2745861451188633,0.25859108034024153,0.26046032872794644,0.26016998242249945,0.2583439607558736,0.2640689916906362,0.26384497074513863,0.2612524430267721,0.24065327150478183,0.24981830948693395,0.23285479202006065,0.27554860547729687,0.273078382747007,0.2746337764584411,0.2455092097499818,0.26526720157173195,0.35506779760135465],[null,0,0.20465908764985974,0.23533238992551092,0.312849757438684,0.2668718399423101,0.29073949447271613,0.30613373855823556,0.2911824915390356,0.2994150052035961,0.3117134170825448,0.30422633388237447,0.3190415755013073,0.3060249547246195,0.321075741000238,0.31532038990092714,0.29086333595561814,0.30619535200072157,0.3066755206016954,0.31010993108308577,0.31794636198998655,0.3097046549647225,0.3051492551073091,0.2985781789053604,0.2957614253755197,0.31414589325663184,0.31658917611098863,0.3191697191697197,0.29905623366193856,0.3178753247125733,0.39050147512815325],[null,null,0,0.13366562594750517,0.2111343377912172,0.20878385922429568,0.21115641210020403,0.22094869848645032,0.21247915488687308,0.2095911336053955,0.21442540727356188,0.2057993763320947,0.23338616314706945,0.21032751039042996,0.22952744729170926,0.2108340042694071,0.20673617257090415,0.20699883403323016,0.206436407086575,0.21837757926264656,0.21965844325324202,0.20987046836459614,0.20571066470814817,0.20292612635314003,0.19189665433373504,0.2285219790463082,0.22063653395448724,0.22835961344770092,0.20348479587154109,0.22199027901628596,0.31897331555469155],[null,null,null,0,0.2589331040883055,0.22248288856929815,0.22658579070072357,0.2532984190492581,0.2218265235882688,0.25546098429907155,0.26946480300087705,0.25777013115519837,0.2702282360629677,0.26063292831329754,0.2848750778490712,0.2648857923396515,0.23079384029467936,0.26630751100130295,0.2621328405934111,0.25927118416631845,0.27680725082151264,0.26289449504634094,0.25295998045578594,0.2560012670960659,0.24597553592939508,0.27489810478484983,0.271877048659767,0.28072807831616564,0.24628754681187576,0.26930111508551113,0.36208543740003485],[null,null,null,null,0,0.22393323725119046,0.16179879497832533,0.14574775057157616,0.16933373999229714,0.12898751137006173,0.12059940199621405,0.09523862602721656,0.1281229257319862,0.09772936794748868,0.12593050126607172,0.10636477616343384,0.16169810335078805,0.09815903475718907,0.09463632005578305,0.1344205570715639,0.1253944740941385,0.11232637608476531,0.05908590849866018,0.10429419573714874,0.05411073825503355,0.1277420798813416,0.12301392678909454,0.13695460020963376,0.1096831440371708,0.11719026685469637,0.25514617047754673],[null,null,null,null,null,0,0.1590731043751179,0.16660146806958895,0.13554995759274283,0.19733669108669127,0.2440508969032463,0.22926393144513976,0.19762875314469286,0.2295935933939293,0.25212577783886536,0.2274456132048416,0.14301278978292403,0.22877124739540877,0.23027048920505322,0.19482390744974648,0.24621078958327317,0.234892465848842,0.21950966864976948,0.22270514254574678,0.2151205943571717,0.24851881898861797,0.24264454318984552,0.25651329468443596,0.22494581294916882,0.24785519756157362,0.3547154281214686],[null,null,null,null,null,null,0,0.08549169883062495,0.07713985073464938,0.13028917856938,0.17675662331702618,0.1663892129496158,0.1538170116609715,0.16695448939576468,0.1906179437639171,0.15992140316804762,0.06616325974547448,0.1644537532750621,0.16960916134573867,0.1287745019708107,0.18281699191934103,0.16540914808532273,0.16100135416410594,0.155145055354787,0.14713341282133235,0.1970238607403039,0.18151361129549073,0.19704431940170217,0.1545830055477708,0.186383471115015,0.301736406769964],[null,null,null,null,null,null,null,0,0.08229361289344508,0.09335496718047051,0.1548173722250904,0.15934764340804622,0.15364087813752264,0.1553360928780393,0.16166045922757344,0.13493881677606512,0.07798909703272117,0.15907567683993873,0.15956536472476088,0.0853224795338889,0.15792498888136483,0.133596688546353,0.14919011357769754,0.12620430464390198,0.1386870959018611,0.16461713621948534,0.16446287213904678,0.1651157846627647,0.13583244216633483,0.16377371696163656,0.2898753069264816],[null,null,null,null,null,null,null,null,0,0.13599907503011532,0.19169409309929458,0.1798081648962523,0.1577705408871517,0.1793540608347657,0.19644915347516037,0.1665972939253141,0.0731295992411764,0.18010132112481123,0.18211121698957294,0.12696033692258518,0.19250502713170517,0.17201067249305516,0.17274045631847654,0.16327139722693418,0.1575228579213479,0.1948126654292763,0.19107196634461757,0.20386894285803703,0.1622453259827422,0.18907423905326606,0.3215708392092622],[null,null,null,null,null,null,null,null,null,0,0.10676088452934084,0.12466957678786537,0.15097536691496422,0.12430227071586133,0.1188590841485137,0.10026934754283742,0.12455656759348034,0.13312488685810842,0.12592257434958778,0.050010140865845557,0.10960447550212643,0.09041852070375557,0.12754366718292898,0.06619107030180853,0.11289856675762715,0.12551201129221265,0.1276665099441945,0.12499431496914722,0.09743559013693238,0.12622968940083037,0.2644057773881602],[null,null,null,null,null,null,null,null,null,null,0,0.10231579801630132,0.18169243368488344,0.10052509710647288,0.08484793310716124,0.08153048713031932,0.1697892850996879,0.09748873888974559,0.09794831147599599,0.11697534847702634,0.07557516588556853,0.05575755340856012,0.12243597426063867,0.0670225188681564,0.10523937052880003,0.10127406150896075,0.1005857886520638,0.09254605852760212,0.07856927747867339,0.10225891744348116,0.24021989149925418],[null,null,null,null,null,null,null,null,null,null,null,0,0.15284036433365294,0.03797769624111905,0.08240482951053417,0.08827859780040982,0.1579741008432285,0.05239562590653192,0.03443085158689184,0.12341900269752624,0.07785683043652837,0.09003698343043974,0.09300940949430876,0.0878065051093574,0.078534706345109,0.09552664896624624,0.07067284644885312,0.0939486943891306,0.10565246414659155,0.08274349857823006,0.23262975838479238],[null,null,null,null,null,null,null,null,null,null,null,null,0,0.15517030508641255,0.18559536101482427,0.16182409592644498,0.14488357466545393,0.16195093357425583,0.15568670702898899,0.15411596233743882,0.1843796863092166,0.17551733780760637,0.11020862526735008,0.16516853299571427,0.11607726725176389,0.18499617924953504,0.18013829477755663,0.199879385156231,0.1631133687341741,0.18642148306577855,0.3152472899956124],[null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.07069535609804063,0.08862408564589767,0.1598337205300294,0.04696903348329522,0.018080018415588883,0.12736280777388156,0.07647864579492095,0.08875806101057773,0.09328413476903405,0.08593116195884648,0.07845619145954714,0.09119133104032429,0.056813125353393806,0.0868773354721341,0.0983231603407777,0.06992490637624862,0.22897735653608164],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.08194402074435622,0.17784896870467357,0.0802261566733043,0.0688073950657843,0.11808114983450553,0.04578808356073457,0.0636975231144694,0.11941007817685662,0.0713381487081151,0.10290120952872624,0.06952337371800453,0.06034245396661501,0.057994613049143204,0.09278133080565959,0.07056900500692444,0.23926444547249956],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.14774427194729214,0.08596327470069076,0.08033924967649797,0.09498303709713099,0.05863701455144405,0.06284647958305675,0.10107293433635711,0.0615329301570912,0.08749062738156695,0.09724296490236078,0.09379701674164753,0.10140657720355699,0.07401618236349777,0.09547159123501402,0.2606815863107813],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.16543201624996948,0.16396650050173558,0.11764418467438598,0.16894774688398867,0.15332681859527506,0.15661640279928882,0.1449193237783843,0.14660629266333972,0.1817402954986849,0.1781336811957619,0.18998574132802343,0.15709691594758715,0.17930023928346092,0.30520370755270104],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.03989707859254838,0.1377620491924184,0.07139722693413965,0.090138692403793,0.10050665916857185,0.09405376502691934,0.08703805283083806,0.10404473881822866,0.06617859908547823,0.09312695134842781,0.10266151633601289,0.0849438359924937,0.2347897884181444],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.12683296848565312,0.06670329810011014,0.08662780871254022,0.09539080885557388,0.08738904412142662,0.08184399493124324,0.09312771959584035,0.05548375003072988,0.08699179036846816,0.09720911778378216,0.07405617778939921,0.23215063739392627],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.10389969370674064,0.08105163851808146,0.1245250694495661,0.06787281510435869,0.12027650760872241,0.1267479165130172,0.12889470708262657,0.12421031150058,0.09311004990535188,0.13013307069515123,0.27689498700404774],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.04991457088772526,0.11291285615950038,0.0621387188501282,0.10354039137596181,0.0755962624251214,0.06757988236595612,0.06552996779506844,0.08119414142904069,0.07306519449975821,0.2458164435303701],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.10761855594070352,0.036722892133965956,0.09456664699953284,0.08197947652645632,0.07989734678073601,0.07445362244019955,0.05798839024510166,0.08346871715160308,0.24305080406171048],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.09836312084634229,0.052399390318853385,0.12901368299858235,0.11555388589784558,0.13342752046611103,0.10036445657251018,0.12502637649449733,0.2623372712298891],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.08283192385541376,0.08436923814440586,0.08884148802353496,0.08023278920929923,0.05923156820807827,0.09017037678950429,0.24548164130798394],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.10763069424982169,0.10522572133310384,0.11960290827740487,0.08813211397104011,0.10240502413321202,0.24707849477144808],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.07446391695552765,0.0685634183117404,0.09988025583663157,0.07289363786847003,0.25871672604055185],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.06503083745113945,0.09408103781006459,0.05454889536265374,0.24042629164273488],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.0990131792145214,0.07744789233883184,0.243916285988434],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.09396861993338497,0.2637279177757369],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0,0.23198389278506748],[null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,0]],
				n = variants.length,
				i, j;

			//matrix of squared proximities: P2 = matrix^2
			var P2 = [];
			for(i = 0; i < n; i ++){
				P2[i] = [];
				for(j = i; j < n; j ++)
					P2[i][j] = Math.pow(matrix[i][j], 2);
			}
			//J = I - 1 * 1' / n
			var J = [],
				n_inv = 1 / n;
			for(i = 0; i < n; i ++){
				J[i] = [];
				for(j = i; j < n; j ++)
					J[i][j] = (i == j? 1: 0) - n_inv;
			}
			//apply the double centering: B = -0.5 * J * P2 * J
			var B = doubleCenter(J, P2, n);
			//extract the m = dimensions largest positive eigenvalues lambda[1]..lambda[m] of B and the corresponding eigenvectors e[1]..e[m]
			var eigen = EVDecomposition.decompose(B);
			var sorter = [];
			for(i = 0; i < n; i ++)
				sorter.push(i);
			sorter.sort(function(a, b){
				return (eigen.eigenvalues_real[b] - eigen.eigenvalues_real[a]);
			});
			var lambda = [],
				E = [];
			for(i = 0; i < n; i ++)
				E[i] = [];
			for(i = 0; i < dimensions; i ++){
				if(eigen.eigenvalues_real[sorter[i]] < 0){
					dimensions = i;
					break;
				}
				lambda.push(eigen.eigenvalues_real[sorter[i]]);
				for(j = 0; j < n; j ++)
					E[j][i] = eigen.eigenvectors[j][sorter[i]];
			}
			//a m-dimensional spatial configuration of the n objects is derived from the coordinate matrix X = E[m] * Λ[m]^0.5,
			//where E[m] is the matrix of m eigenvectors and Λ[m] is the diagonal matrix of m eigenvalues of B
			lambda = lambda.map(function(el){ return Math.sqrt(el); });
			var X = multiplyDiagonal(E, lambda, n, dimensions);


			//verify scaling
			var r = [];
			for(i = 0; i < n; i ++){
				r[i] = [];
				r[i][i] = 0;
				for(j = i + 1; j < n; j ++)
					r[i][j] = euclideanDistance(X[i], X[j]);
			}
			var reg = linearRegression(reduceMatrix(matrix), reduceMatrix(r));

//console.log(JSON.stringify(B));
//console.log(JSON.stringify(eigen));
//console.log(JSON.stringify(lambda));
//console.log(JSON.stringify(E));
console.log(JSON.stringify(X));
console.log('r2 = ' + reg.r2);
		});

	</script>
</head>

<body>
</body>
</html>
