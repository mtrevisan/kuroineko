<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="author" content="Mauro Trevisan">
	<link rel="shortcut icon" href="../favicon.png" />

	<title>test</title>

	<script src="../app/AMDLoader.js"></script>

	<script>
		AMDLoader.config = {
			baseUrl: '../app',
			paths: {
				libs: '../libs'
			}
		};


		var composeInfinitive = (function(){
			var themeVowel = ['à', 'é', 'e', 'í', 'í'];

			return function(v){
				return (v.prefix + v.radix).replace(/ɉ/g, 'j') + themeVowel[v.conjugation - 1] + 'r';
			};
		})();

		var expandForm = (function(){
			var add = function(list, value){
				if(list.indexOf(value) < 0)
					list.push(value);
			};


			return function recurse(forms, list){
				var m;
				if(!Array.isArray(list))
					list = [];
				[].concat(forms).forEach(function(form){
					m = form.match(/^(.*)([\(\[])(.+)[\)\]](.*)$/);
					if(m){
						m[1] = m[1] || '';
						m[4] = m[4] || '';

						if(m[2] == '('){
							recurse(m[1] + m[4], list);
							if(m[3].indexOf('/') >= 0)
								m[3].split('/').forEach(function(el){
									recurse(m[1] + el + m[4], list);
								});
							else
								recurse(m[1] + m[3] + m[4], list);
						}
						else
							m[3].split(m[3].indexOf('/') >= 0? '/': '').forEach(function(el){
								recurse(m[1] + el + m[4], list);
							});
					}
					else
						add(list, form);
				});
				return list;
			};
		})();


		require(['tools/lang/morphology/AFFFileRules', 'tools/lang/morphology/Verb', 'tools/lang/data/VerbsDictionary', 'libs/jsonh'], function(AFFFileRules, Verb, verbsDictionary, JSONH){
			verbsDictionary = JSONH.unpack(verbsDictionary);

			var start = +new Date();

			var verbs = [],
				inf;
			verbsDictionary.forEach(function(infinitive){
				inf = composeInfinitive(infinitive);

//if(['domàr', 'domandàr', 'domenàr', 'domestegàr'].indexOf(inf) >= 0){
//if(['skoltàr', 'kovèrđer'].indexOf(inf) >= 0){
//if(['èser', 'avér', 'xbolŧàr'].indexOf(inf) >= 0){
					inf = inf.replace(/(^|[aeiouàèéíòóú])l([aeiouàèéíòóú])/g, '$1[lƚ]$2')
						.replace(/([^lnr])đ([aeiouàèéíòóú])/g, '$1[đx]$2')
						.replace(/([lnr])đ([aeiouàèéíòóú])/g, '$1[dđx]$2')
						.replace(/ŧ/g, '[sŧ]')
						.replace(/[jɉ]/g, '[jɉ]');
					expandForm(inf).forEach(function(t){
						if(verbs.indexOf(t) < 0)
							verbs.push(t);
					});
//				}
			});
			verbs = verbs.map(function(v){ return new Verb(v); });

			/*var verbs = [],
				infinitives = [],
				maxIndex = 0;
			verbsDictionary.forEach(function(infinitive, idx){
//if(idx < 1000)
//	return;
				infinitive = composeInfinitive(infinitive);
				if(infinitives.indexOf(infinitive) < 0){
					infinitives.push(infinitive);

if(['skoltàr', 'abdikàr'].indexOf(infinitive) >= 0)
//if(['domàr', 'indomàr', 'domandàr', 'redomandàr', 'domenàr', 'predomenàr', 'domestegàr'].indexOf(infinitive) >= 0 || idx <= maxIndex)
//if(['skoltàr', 'abdikàr'].indexOf(infinitive) >= 0 || idx <= maxIndex)
//if(idx <= maxIndex)
					verbs.push(new Verb(infinitive));
				}
			});*/
			AFFFileRules.generate(verbs);

			console.log(((+new Date() - start) / 1000).toFixed(2) + ' s');
		});

	</script>
</head>

<body>
</body>
</html>
